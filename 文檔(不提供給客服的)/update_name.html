<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>Adjust更換應用名</title>
  </head>
  <style>
    .input-content {
      width: 240px;
      height: 25px;
      padding: 0px 4px;
    }
  </style>
  <body style="padding: 30px 50px; margin: 0 auto">
    <!-- <h3>請貼上後台應用列表:</h3>
    <h4 style="font-size: 16px; color: gray; margin: 10px 0px">
      內容取得位置後台api: https://api.adjust.com/dashboard/api/apps/
    </h4>
    <textarea
      id="textContent"
      style="width: 100%; height: 200px; padding: 10px"
      placeholder="請貼上"
      oninput="onTransformAppslist(event)"
    ></textarea> -->

    <div>
      <div>
        <h3>應用名列表:</h3>
        <pre id="appListResult" style="height: 300px; overflow: auto"></pre>
      </div>
      <div
        style="
          width: 100%;
          height: 2px;
          background-color: lightgrey;
          margin: 20px 0;
        "
      ></div>
      <div>
        將
        <input
          id="originText"
          class="input-content"
          oninput="onHandleInputOriginText(this)"
          onkeydown="onHandleKeydown(event)"
          placeholder="原始文字"
        />
        取代
        <input
          id="newText"
          class="input-content"
          oninput="onHandleInputnewText(this)"
          onkeydown="onHandleKeydown(event)"
          placeholder="取代文字"
        />
        <button
          id="replaceBtn"
          onclick="onHandleReplace()"
          onkeydown="onHandleKeydown(event)"
        >
          確定
        </button>
      </div>
      <div style="display: flex">
        <div style="margin-right: 50px">
          <h3>要更換應用名列表:</h3>
          <div id="originListResult"></div>
        </div>
        <div>
          <h3>更換後應用名列表:</h3>
          <div id="replacedListResult"></div>
        </div>
      </div>
    </div>

    <script>
      let appList = []; //應用列表
      let originKeyword = ""; //原始文字
      let replaceKeyword = ""; // 取代文字
      let originList = []; //要替換應用名列表
      let replacedList = []; //更換後應用名列表

      (async () => {
        await init();
      })();

      async function init() {
        const token = localStorage.getItem("authToken");

        if (!!token) {
          await getAppList();
        } else {
          await login();
        }
      }

      async function fetchApi({
        apiUrl,
        method,
        headers = {},
        body,
        callback,
        errorCallback,
      }) {
        try {
          const token = localStorage.getItem("authToken");
          const response = await fetch(apiUrl, {
            method,
            headers: {
              "Content-Type": "application/json",
              ...(token ? { Authorization: `Bearer ${token}` } : {}),
              ...headers,
            },
            body,
          });

          if (!response.ok) throw new Error("網路回應錯誤");
          let data = null;
          if (
            (response.status === 200 || response.status === 201) &&
            response?.statusText !== "No Content"
          ) {
            data = await response?.json();
          }

          if (callback) callback(data);
          return data;
        } catch (error) {
          if (errorCallback) errorCallback();
          return false;
        }
      }

      async function login() {
        const data = await fetchApi({
          apiUrl: "https://api.adjust.com/accounts/users/sign_in",
          method: "POST",
          body: JSON.stringify({
            user: {
              email: atob("dGVjaGFkanVzdDA1MTlAZ21haWwuY29t"),
              password: atob("QHRlY2g2NjY2ISEh"),
              remember_me: false,
            },
          }),
        });

        if (data?.authentication_token) {
          localStorage.setItem("authToken", data.authentication_token);
          getAppList();
        }
      }

      // 取得應用列表
      async function getAppList() {
        const data = await fetchApi({
          apiUrl: "https://api.adjust.com/dashboard/api/apps?ctv=false",
          method: "GET",
        });
        appList = data.apps || [];
        onTransformAppslist();
      }

      function onTransformAppslist() {
        const appsNameList = appList.map((el) => el.name);
        const appListResultEl = document.getElementById("appListResult");
        const content = appsNameList.join("\n") + "\n";
        appListResultEl.textContent = content;
      }

      function renderList(keyword) {
        const replaceListResult = document.getElementById("originListResult");
        replaceListResult.textContent = "";

        const escapedKeyword = keyword.replace(
          /[-\/\\^$*+?.()|[\]{}]/g,
          "\\$&"
        );

        const regex = new RegExp(`(${escapedKeyword})`, "gi");
        let content = "";
        originList = [];
        onReplaceList("");

        appList.forEach((appObject) => {
          if (keyword) {
            originKeyword = keyword;
            const name = appObject.name;
            highlightedText = name.replace(regex, `<mark>$1</mark>`);
            if (!!regex.test(name)) {
              const div = document.createElement("div");
              div.innerHTML = highlightedText;
              replaceListResult.appendChild(div);
              originList.push(name);
              console.log("--------------replaceKeyword", replaceKeyword);
              onReplaceList(replaceKeyword);
            }
          }
        });
      }

      function onReplaceList(keyword) {
        if (!originKeyword) return;
        const replacedListResult =
          document.getElementById("replacedListResult");
        replacedListResult.textContent = "";

        const escapedKeyword = originKeyword.replace(
          /[-\/\\^$*+?.()|[\]{}]/g,
          "\\$&"
        );
        const regex = new RegExp(`(${escapedKeyword})`, "gi");
        let content = "";
        replacedList = [];

        appList.forEach((appObject) => {
          if (keyword) {
            const name = appObject.name;
            highlightedText = name.replace(regex, `<mark>${keyword}</mark>`);
            if (!!regex.test(name)) {
              const div = document.createElement("div");
              div.innerHTML = highlightedText;
              replacedListResult.appendChild(div);
              replacedList.push(name.replace(regex, keyword));
            }
          }
        });
      }

      function onHandleInputOriginText(el) {
        const keyword = el.value.trim();
        if (!keyword) {
          const originListResult = document.getElementById("originListResult");
          const replaceListResult =
            document.getElementById("replacedListResult");
          originListResult.textContent = "";
          replacedListResult.textContent = "";
          return;
        } else {
          renderList(keyword);
        }
      }

      function onHandleInputnewText(el) {
        const keyword = el.value.trim();
        replaceKeyword = keyword;
        if (!keyword) {
          const replaceListResult =
            document.getElementById("replacedListResult");
          replacedListResult.textContent = "";
          return;
        } else {
          onReplaceList(keyword);
        }
      }

      function onHandleReplace() {
        if (
          originList.length === 0 ||
          replacedList.length === 0 ||
          originList.length !== replacedList.length
        )
          return;

        console.log(
          "--------------------onHandleReplace",
          originList,
          replacedList
        );
        const appMap = new Map(appList.map((app) => [app.name, app]));
        originList.forEach((el, i) => {
          const currentApp = appMap.get(el);
          console.log("-------------appMap", currentApp);
          if (!!currentApp && replacedList[i]) {
            fetchApi({
              apiUrl: `https://api.adjust.com/dashboard/api/apps/${currentApp.app_token}`,
              method: "PUT",
              body: JSON.stringify({
                name: replacedList[i],
                is_child_directed: currentApp.is_child_directed,
                no_eea_users: currentApp.no_eea_users,
              }),
            });
          }
        });
      }

      function onHandleKeydown(event) {
        if (event.key === "Enter") {
          onHandleReplace();
        }
      }
    </script>
  </body>
</html>
